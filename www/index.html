<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
<!--     <link rel="stylesheet" type="text/css" href="css/index.css" /> -->
    <title>Fuelo</title>
    
    <script src="js/jquery-1.9.1.min.js"></script>
	<link href="css/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<!--	<link href="css/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet"> -->
	<script src="css/bootstrap/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="css/fontawesome/css/font-awesome.min.css">
	
 <script type="text/javascript" charset="utf-8">

    // Wait for Cordova to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

    var directionsDisplay;
    var directionsService
	var map;
	var fuel_type;
	var mylat;
	var mylon;
	var destlat;
	var destlon;

    // Cordova is ready
    //
    function onDeviceReady() {

    	directionsService = new google.maps.DirectionsService();
    	
    	var avg_price = window.localStorage.getItem("avg_price");
    	$('#avg_price').empty().append(avg_price);
    	
    	fuel_type = window.localStorage.getItem("fuel_type");
    	
    	var fuel_name = window.localStorage.getItem("fuel_name");
    	$('#fuel').empty().append(fuel_name);
    	var diff_formatted = window.localStorage.getItem("diff_formatted");
    	$('#diff').empty().append(diff_formatted);

        navigator.geolocation.getCurrentPosition(onSuccess, onError);
        
        // Refresh data
        refresh_info()
        
    }

    // onSuccess Geolocation
    //
    function onSuccess(position) {
    	mylat = position.coords.latitude;
    	mylon = position.coords.longitude;
		nearest_gasstation(position.coords.latitude,position.coords.longitude);
    }

    // onError Callback receives a PositionError object
    //
    function onError(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }
    
    function refresh_info()
    {
    	$('#refresh').empty().append('<a href="#"><i  class="icon-refresh icon-spin icon-large text-info"></i></a>');
    	get_avg_price();
    	get_diff_price();
    	navigator.geolocation.getCurrentPosition(onSuccess, onError);
    	
    	
    }
    
	function nearest_gasstation(latitude,longitude)
	{
		// Get near gasstations by ajax
		$.ajax({
			url: 'http://fuelo.net/api/get_recommended_gasstation',
			type:'POST',
			dataType: 'text',
			data: { lat:latitude,lon:longitude,fuel:fuel_type },
			success: function(data){
				var obj = jQuery.parseJSON(data);
					$('#nearest_gasstation').empty().append(obj.text);
					destlat = obj.lat;
					destlon = obj.lon;
					initialize(obj.lat,obj.lon,obj.brand);
				} // End of success function of ajax form
			}); // End of ajax call 

	}

	function get_avg_price()
	{
		// Get near gasstations by ajax
		$.ajax({
			url: 'http://fuelo.net/api/get_avg_price',
			type:'POST',
			dataType: 'text',
			data: { fuel:fuel_type },
			success: function(data){
				var obj = jQuery.parseJSON(data);
					$('#avg_price').empty().append(obj.avg_price);
					window.localStorage.setItem("avg_price", obj.avg_price);
				} // End of success function of ajax form
			}); // End of ajax call 
	}
	
	function get_diff_price()
	{
		// Get near gasstations by ajax
		$.ajax({
			url: 'http://fuelo.net/api/get_diff_price',
			type:'POST',
			dataType: 'text',
			data: { fuel:fuel_type },
			success: function(data){
				var obj = jQuery.parseJSON(data);
					$('#diff').empty().append(obj.diff_formatted);
					window.localStorage.setItem("diff_formatted", obj.diff_formatted);
					window.localStorage.setItem("diff", obj.diff);
				} // End of success function of ajax form
			}); // End of ajax call 
	}

function initialize(latitude,longitude,brand)
{
	directionsDisplay = new google.maps.DirectionsRenderer();
	var mapProp = {
	  center:new google.maps.LatLng(latitude,longitude),
	  zoom:15,
	  mapTypeId:google.maps.MapTypeId.ROADMAP
	  };
	map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
	directionsDisplay.setMap(map);
	directionsDisplay.setPanel(document.getElementById("directionsPanel"));

	var marker=new google.maps.Marker({
	  position:new google.maps.LatLng(latitude,longitude),
	  icon:'http://fuelo.net/img/logos/'+brand+'-small.png',
	  map: map,
	  title: "Gasstation"
	  });
	  
  	var visitor=new google.maps.Marker({
	  position:new google.maps.LatLng(mylat,mylon),
	  map: map,
	  title: "Вие се намирате тук"
	  });
	  
	  $('#refresh').empty().append('<a href="#"><i  class="icon-refresh icon-large"></i></a>');
}

function calcRoute() {
  var start = new google.maps.LatLng(mylat,mylon);
  var end = new google.maps.LatLng(destlat,destlon);
  var request = {
    origin:start,
    destination:end,
    travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, function(result, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(result);
    } else { alert (status); } 
  });
}

</script>
    
</head>
<body>
    <div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<ul class="nav">
				<li><a class="brand" href="index.html" style="padding:8px 15px 10px 35px;"> <img src="img/logo-72x24.gif" alt="Fuelo"/></a></li>
			</ul>
			<ul class="nav pull-right">
				<li class="divider-vertical"></li>
				<li id="refresh" onclick="refresh_info();"><a href="#"><i class="icon-refresh icon-spin icon-large"></i></a></li>
				<li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
						  <i class="icon-reorder icon-large"></i> </a>
                        <ul class="dropdown-menu">
							<li><a href="gasstations.html"><img src="img/gas_station-black.png" alt="Бензиностанции" /> Бензиностанции</a></li>
							<li><a href="prices.html">$ Цени</a></li>
							<li><a href="settings.html"><i class="icon-wrench"></i> Настройки</a></li>
							<li class="divider"></li>
							<li><a href="#" onclick="navigator.app.exitApp()"><i class="icon-off"></i> Изход</a></li>
                        </ul>
                    </li>
			</ul>
		</div>
	</div>
	
    <h3 style="padding-top:40px;"><span id="fuel">Пропан Бутан</span> <a href="settings.html" class="btn" title="Настройки"><i class="icon-cogs"></i></a></h3>
	<div class="well well-small" style="margin-left:5px;margin-right:5px;" align="center">
		<div class="pull-left">
			<div  class="muted">цената днес</div>
			<div>
				<span id="diff"></span>
			</div>
		</div>
		<div>
			<h2><span id="avg_price"></span> лв.</h2>
		</div>
	</div>
	
	<p> </p>
	<div id='nearest_gasstation'></div>
	<div id="googleMap" style="width:100%;height:180px;text-align:center;"><h1><i class="icon-spinner icon-spin icon-large"></i></h1><h5>Търсене на местоположението</h5></div>
	
	<div class="accordion" id="accordion2">
	  <div class="accordion-group">
		<div class="accordion-heading">
		  <a class="accordion-toggle btn" data-toggle="collapse" data-parent="#accordion2" onclick="calcRoute();" href="#collapseOne">
			<span align="center">Маршрут до там</span>
		  </a>
		</div>
		<div id="collapseOne" class="accordion-body collapse">
		  <div class="accordion-inner">
			<div id="directionsPanel"></div>
		  </div>
		</div>
	  </div>
	</div>

    <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCqlpdOpEJ0Zp2le2Q6XR_nzqFM5i16etU&sensor=false&language=bg"></script>
    <script type="text/javascript">
        app.initialize();
    </script>
</body>
</html>
