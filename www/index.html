<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>Fuelo</title>
    
    <script src="js/jquery-1.9.1.min.js"></script>
	<link href="css/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="css/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
	<script src="css/bootstrap/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="css/fontawesome/css/font-awesome.min.css">
	
 <script type="text/javascript" charset="utf-8">

    // Wait for Cordova to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

    var watchID = null;

    // Cordova is ready
    //
    function onDeviceReady() {
    	var avg_price = window.localStorage.getItem("avg_price");
    	$('#avg_price').empty().append(avg_price);
        // Throw an error if no update is received every 30 seconds
        var options = { timeout: 30000 };
        watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
        
        // Refresh data
        get_avg_price();
    }

    // onSuccess Geolocation
    //
    function onSuccess(position) {
        var element = document.getElementById('geolocation');
        element.innerHTML = 'Latitude: '  + position.coords.latitude      + '<br />' +
                            'Longitude: ' + position.coords.longitude     + '<br />' +
                            '<hr />'      + element.innerHTML;
		nearest_gasstation(position.coords.latitude,position.coords.longitude);
    }

    // onError Callback receives a PositionError object
    //
    function onError(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }
    
	function nearest_gasstation(latitude,longitude)
	{
		// Get near gasstations by ajax
		$.ajax({
			url: 'http://fuelo.net/m/ajax_get_recommended_gasstation',
			type:'POST',
			dataType: 'text',
			data: { lat:latitude,lon:longitude,fuel:'lpg' },
			success: function(data){
				var obj = jQuery.parseJSON(data);
					$('#nearest_gasstation').empty().append(obj.text);
					destlat = obj.lat;
					destlon = obj.lon;
					initialize(obj.lat,obj.lon,obj.brand);
				} // End of success function of ajax form
			}); // End of ajax call 

	}

	function get_avg_price()
	{
		// Get near gasstations by ajax
		$.ajax({
			url: 'http://fuelo.net/api/get_avg_price',
			type:'POST',
			dataType: 'text',
			data: { fuel_type:'lpg' },
			success: function(data){
				var obj = jQuery.parseJSON(data);
					$('#avg_price').empty().append(obj.price);
					window.localStorage.setItem("avg_price", obj.price);
				} // End of success function of ajax form
			}); // End of ajax call 

	}
</script>
    
</head>
<body>
    	<div class="navbar navbar-inverse">
		<div class="navbar-inner">
			
			<ul class="nav">
				<li><a class="brand" href="index.html">Fuelo</a></li>
				<li class="divider"> </li>
				<li><a href="gasstations.html"><img src="img/gas_station.png" alt="Бензиностанции" /> </a></li>
				<li class="divider"> </li>
				<li><a href="prices.html"><img src="img/coins.png" alt="Цени" /> </a></li>
				<li class="divider"> </li>
			</ul>
			<ul class="nav pull-right">
				<li><a href="#"><img src="img/settings.png" alt="Настройки" /> </a></li>
			</ul>
		</div>
	</div>
	
    <p id="geolocation">Watching geolocation...</p>
    <h3>Пропан Бутан</h3>
	<div class="well well-small" align="center">
		<div class="pull-left">
			<div  class="muted">цената днес</div>
			<div>
				<span id="diff"></span>+0.01
			</div>
		</div>
		<div>
			<h2><span id="avg_price"></span> лв.</h2>
		</div>
	</div>
	
	<p> </p>
	<div id='nearest_gasstation'></div>

    <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript">
        app.initialize();
    </script>
</body>
</html>
