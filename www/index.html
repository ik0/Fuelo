<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
<!--     <link rel="stylesheet" type="text/css" href="css/index.css" /> -->
    <title>Fuelo</title>
    
    <script src="js/jquery-1.9.1.min.js"></script>
	<link href="css/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<!--	<link href="css/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet"> -->
	<script src="css/bootstrap/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="css/fontawesome/css/font-awesome.min.css">
		<script src="js/jquery.mobile-1.3.1.min.js"></script>
	<link rel="stylesheet" href="css/jquery.mobile-1.3.1.min.css">


 <script type="text/javascript" charset="utf-8">

    // Wait for Cordova to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

    var directionsDisplay;
    var directionsService
	var map;
	var fuel_type = 'gasoline';
	var fuel_name = 'Бензин А95';
	var avg_price = '0,00';
	var diff_formatted = '+0,00';
	
	var mylat;
	var mylon;
	var destlat;
	var destlon;

    // Cordova is ready
    //
    function onDeviceReady() {

    	directionsService = new google.maps.DirectionsService();
    	fuel_type = window.localStorage.getItem("fuel_type");
    	fuel_name = window.localStorage.getItem("fuel_name");
    	
    	if (fuel_type == null) {
			fuel_type = 'gasoline';
			fuel_name = 'Бензин А95';
			window.localStorage.setItem("fuel_type", "gasoline");
			window.localStorage.setItem("fuel_name", "Бензин А95");
		}

    	avg_price = window.localStorage.getItem("avg_price");
    	$('#avg_price').empty().append(avg_price);
    	
    	$('#fuel').empty().append(fuel_name);
    	diff_formatted = window.localStorage.getItem("diff_formatted");
    	$('#diff').empty().append(diff_formatted);


        navigator.geolocation.getCurrentPosition(onSuccess, onError, { maximumAge: 30000, timeout: 15000, enableHighAccuracy: true });
        
        // Refresh data
        refresh_info()
        
        
        // Fuelselect 
        $("#fuelselect").val(fuel_type);

		$('#fuelselect').on('change', function() {
		  	fuel_type = this.value;
		   	fuel_name = $("#fuelselect option:selected").text();;
			window.localStorage.setItem("fuel_type", fuel_type);
			window.localStorage.setItem("fuel_name", fuel_name);
			get_avg_price();
			get_diff_price();
			$('#fuel').empty().append(fuel_name);
			$.mobile.changePage('#saved', 'pop');
			//$('#result').empty().append('<i class="icon-ok"></i>Saved');
		});

    }

    // onSuccess Geolocation
    //
    function onSuccess(position) {
    	mylat = position.coords.latitude;
    	mylon = position.coords.longitude;
		nearest_gasstation(position.coords.latitude,position.coords.longitude);
    }

    // onError Callback receives a PositionError object
    //
    function onError(error) {
        alert('Не може да открием Вашето местоположение\n' + 'Моля проверете настройките на телефона Ви\n' + error.message + '\n');
    }
    
    function refresh_info()
    {
    	$('#refresh').empty().append('<a href="#"><i  class="icon-refresh icon-spin icon-large"></i></a>');
    	
    	$('#avg_price').empty().append(avg_price);
    	$('#fuel').empty().append(fuel_name);
    	$('#diff').empty().append(diff_formatted);
    	
    	get_avg_price_gasoline();
    	get_avg_price_diesel();
    	get_avg_price_lpg();
    	get_avg_price_methane();
    	
    	get_avg_price();
    	get_diff_price();
    	navigator.geolocation.getCurrentPosition(onSuccess, onError);
    }
    
    function refresh_gasstations()
    {
    	get_gasstattions();
    	$('#gasstations_list').listview('refresh');
    }
    
	function nearest_gasstation(latitude,longitude)
	{
		// Get near gasstations by ajax
		$.ajax({
			url: 'http://fuelo.net/api/get_recommended_gasstation',
			type:'POST',
			dataType: 'text',
			data: { lat:latitude,lon:longitude,fuel:fuel_type },
			success: function(data){
				var obj = jQuery.parseJSON(data);
					$('#nearest_gasstation').empty().append(obj.text);
					destlat = obj.lat;
					destlon = obj.lon;
					initialize(obj.lat,obj.lon,obj.brand);
				} // End of success function of ajax form
			}); // End of ajax call 

	}

function initialize(latitude,longitude,brand)
{
	directionsDisplay = new google.maps.DirectionsRenderer();
	var mapProp = {
	  center:new google.maps.LatLng(latitude,longitude),
	  zoom:15,
	  mapTypeId:google.maps.MapTypeId.ROADMAP
	  };
	map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
	directionsDisplay.setMap(map);
	directionsDisplay.setPanel(document.getElementById("directionsPanel"));

	var marker=new google.maps.Marker({
	  position:new google.maps.LatLng(latitude,longitude),
	  icon:'http://fuelo.net/img/logos/'+brand+'-small.png',
	  map: map,
	  title: "Gasstation"
	  });
	  
  	var visitor=new google.maps.Marker({
	  position:new google.maps.LatLng(mylat,mylon),
	  map: map,
	  title: "Вие се намирате тук"
	  });
	  
	  $('#refresh').empty().append('<a href="#"><i  class="icon-refresh icon-large"></i></a>');
}

function calcRoute() {
  var start = new google.maps.LatLng(mylat,mylon);
  var end = new google.maps.LatLng(destlat,destlon);
  var request = {
    origin:start,
    destination:end,
    travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, function(result, status) {
    if (status == google.maps.DirectionsStatus.OK) {
    	$('#directionsPanel').empty()
      	directionsDisplay.setDirections(result);
    } else { alert (status); } 
  });
}
</script>
    
</head>
<body>
	
<div data-role="page" id="index">
    <div data-theme="d" data-role="header" data-position="fixed" data-id="topnav">
        <div class="navbar">
			<ul class="nav">
				<li><a class="brand" href="index.html" style="padding:8px 15px 10px 30px;"> <img src="img/logo-72x24.gif" alt="Fuelo"/></a></li>
			</ul>
			<ul class="nav pull-right">
				<li id="refresh" onclick="refresh_info();"><a href="#"><i class="icon-refresh icon-spin icon-large"></i></a></li>
				<li><a href="#settings" data-transition="slide"><i class="icon-reorder icon-large"></i></a></li>
			</ul>
		</div>
    </div>
    
    <div data-role="content">

		<h3><span id="fuel"></span></h3>
		<div class="well well-small" style="margin-left:5px;margin-right:5px;" align="center">
			<div class="pull-left">
				<div  class="muted">цената днес</div>
				<div>
					<span id="diff"></span>
				</div>
			</div>
			<div>
				<h2><span id="avg_price"></span> лв.</h2>
			</div>
		</div>
	
		<p> </p>
		<div id='nearest_gasstation'></div>
		<div id="googleMap" style="width:100%;height:180px;text-align:center;"><h5><i class="icon-spinner icon-spin icon-large"></i> Търсене на местоположението</h5></div>
	
		<div data-role="collapsible-set">
			<div data-role="collapsible" data-collapsed="true">
				<h3 onclick="calcRoute();">
					Маршрут до там
				</h3>
				<div id="directionsPanel"></div>
			</div>
		</div>

    </div>
    <div data-theme="d" data-role="footer" data-position="fixed" data-id="bottomnav">
		<div data-role="navbar">
            <ul>
                <li>
                    <a href="#index" data-transition="fade" data-theme="d" class="ui-btn-active ui-state-persist">
                        <i class="icon-location-arrow icon-large"></i>
                        <br /><small>Начало</small>
                    </a>
                </li>
                <li>
                    <a href="#gasstations" data-transition="slide" data-theme="d">
                    	<i class="icon-fire icon-large"></i>
                        <br /><small>Наблизо</small>
                    </a>
                </li>
                <li>
                    <a href="#prices" data-transition="slide" data-theme="d">
                    	<i class="icon-money icon-large"></i>
                        <br /><small>Цени</small>
                    </a>
                </li>
            </ul>
        </div>
   </div>
</div>	<!-- end index -->

<!-- gasstations -->
<div data-role="page" id="gasstations">
    <div data-theme="d" data-role="header" data-position="fixed" data-id="topnav">
        <div class="navbar">
			<ul class="nav">
				<li><a class="brand" href="index.html" style="padding:8px 15px 10px 30px;"> <img src="img/logo-72x24.gif" alt="Fuelo"/></a></li>
			</ul>
			<ul class="nav pull-right">
				<li id="refresh_gasstations" onclick="refresh_gasstations();"><a href="#"><i class="icon-refresh icon-large"></i></a></li>
				<li><a href="#settings" data-transition="slide"><i class="icon-reorder icon-large"></i></a></li>
			</ul>
		</div>
    </div>
    
    <div data-role="content">
		<ul data-role="listview" id="gasstations_list">

		</ul>
    </div>
    
    <div data-theme="d" data-role="footer" data-position="fixed" data-id="bottomnav">
		<div data-role="navbar">
            <ul>
                <li>
                    <a href="#index" data-transition="fade" data-theme="">
                        <i class="icon-location-arrow icon-large"></i>
                        <br /><small>Начало</small>
                    </a>
                </li>
                <li>
                    <a href="#gasstations" data-transition="fade" data-theme=""  class="ui-btn-active ui-state-persist">
                    	<i class="icon-fire icon-large"></i>
                        <br /><small>Наблизо</small>
                    </a>
                </li>
                <li>
                    <a href="#prices" data-transition="fade" data-theme="">
                    	<i class="icon-money icon-large"></i>
                        <br /><small>Цени</small>
                    </a>
                </li>
            </ul>
        </div>
   </div>
</div>	<!-- end gasstations -->


<!-- prices -->
<div data-role="page" id="prices">
    <div data-theme="d" data-role="header" data-position="fixed" data-id="topnav">
        <div class="navbar">
			<ul class="nav">
				<li><a class="brand" href="index.html" style="padding:8px 15px 10px 30px;"> <img src="img/logo-72x24.gif" alt="Fuelo"/></a></li>
			</ul>
			<ul class="nav pull-right">
				<li id="refresh_prices" onclick="refresh_prices();"><a href="#"><i class="icon-refresh icon-large"></i></a></li>
				<li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
					  <i class="icon-reorder icon-large"></i> </a>
                    <ul class="dropdown-menu">
						<li><a href="gasstations.html"><img src="img/gas_station-black.png" alt="Бензиностанции" /> Бензиностанции</a></li>
						<li><a href="prices.html">$ Цени</a></li>
						<li><a href="settings.html"><i class="icon-wrench"></i> Настройки</a></li>
						<li class="divider"></li>
						<li><a href="#" onclick="navigator.app.exitApp()"><i class="icon-off"></i> Изход</a></li>
                    </ul>
                </li>
			</ul>
		</div>
    </div>
    
    <div data-role="content">
		<h2>Цените днес</h2>
        <div data-role="collapsible-set" data-theme="c" data-content-theme="c">
            <div data-role="collapsible" data-collapsed="false">
                <h4><span>Бензин А95</span><span class="pull-right"><span id="gasolineprice"></span>лв.</span></h4>
            </div>
            <div data-role="collapsible" data-collapsed="false">
                <h4><span>Дизел</span><span class="pull-right"><span id="dieselprice"></span>лв.</span></h4>
            </div>
            <div data-role="collapsible" data-collapsed="false">
                <h4><span>Автогаз</span><span class="pull-right"><span id="lpgprice"></span>лв.</span></h4>
            </div>
            <div data-role="collapsible" data-collapsed="false">
                <h4><span>Метан</span><span class="pull-right"><span id="methaneprice"></span>лв.</span></h4>
            </div>
        </div>

    </div>
    
    <div data-theme="d" data-role="footer" data-position="fixed" data-id="bottomnav">
		<div data-role="navbar">
            <ul>
                <li>
                    <a href="#index" data-transition="fade" data-theme="">
                        <i class="icon-location-arrow icon-large"></i>
                        <br /><small>Начало</small>
                    </a>
                </li>
                <li>
                    <a href="#gasstations" data-transition="fade" data-theme="">
                    	<i class="icon-fire icon-large"></i>
                        <br /><small>Наблизо</small>
                    </a>
                </li>
                <li>
                    <a href="#prices" data-transition="fade" data-theme="" class="ui-btn-active ui-state-persist">
                    	<i class="icon-money icon-large"></i>
                        <br /><small>Цени</small>
                    </a>
                </li>
            </ul>
        </div>
   </div>
</div>	<!-- end prices -->

<!-- settings -->
<div data-role="page" id="settings">
    <div data-theme="d" data-role="header" data-position="fixed" data-id="topnav">
        <div class="navbar">
			<ul class="nav">
				<li><a class="brand" href="#index" style="padding:8px 15px 10px 30px;"> <img src="img/logo-72x24.gif" alt="Fuelo"/></a></li>
			</ul>
		</div>
    </div>
    
    <div data-role="content">
    	<h2>Настройки</h2>
		<a href="#index" data-role="button" data-inline="true" data-transition="slide reverse" data-icon="arrow-l"> Назад</a>
		<br />
		<strong>Горивото, което зареждате.</strong>
		<div data-role="fieldcontain">
			<select id="fuelselect" name="fuel" data-mini="true">
				<option value="gasoline">Бензин А95</option>
				<option value="diesel">Дизел</option>
				<option value="lpg">Пропан Бутан</option>
				<option value="methane">Метан</option>
				<option value="electricity">Ток</option>
			</select>
  		</div>
  		<div id="result"></div>
  		
    </div>
    
    <div data-theme="d" data-role="footer" data-position="fixed" data-id="bottomnav">
		<div data-role="navbar">
            <ul>
                <li>
                    <a href="#index" data-transition="slide reverse" data-theme="">
                        <i class="icon-location-arrow icon-large"></i>
                        <br /><small>Начало</small>
                    </a>
                </li>
                <li>
                    <a href="#gasstations" data-transition="slide reverse" data-theme="">
                    	<i class="icon-fire icon-large"></i>
                        <br /><small>Бензиностанции</small>
                    </a>
                </li>
                <li>
                    <a href="#prices" data-transition="slide reverse" data-theme="">
                    	<i class="icon-money icon-large"></i>
                        <br /><small>Цени</small>
                    </a>
                </li>
            </ul>
        </div>
   </div>
</div>	<!-- end settings -->

<!-- saved popup -->
<div data-role="dialog" id="saved">
	<div data-role="header">
		<h2>Запазено</h2>
	</div>
	<div data-role="content">
		<p style="text-align: center;">Вашите настройки бяха записани.</a></p>
		<p><a href="#settings" data-transition="slide reverse" data-role="button">OK</a></p>
	</div>
</div>	<!-- end saved popup -->


<!--    <script type="text/javascript" src="phonegap.js"></script> -->
    <script type="text/javascript" src="js/index.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCqlpdOpEJ0Zp2le2Q6XR_nzqFM5i16etU&sensor=false&language=bg"></script>
    <script type="text/javascript" src="js/api.js"></script>
    <script type="text/javascript">
        app.initialize();
    </script>

</body>
</html>
